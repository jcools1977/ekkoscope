`; navigator.clipboard.writeText(code).then(() => { alert('Code copied to clipboard!'); }); } async function downloadPatchKit() { const zip = new JSZip(); zip.file("schema-fix.html", ` `); zip.file("meta-fix.html", ``); zip.file("README.txt", `EkkoScope Patch Kit for ${businessName} Generated: ${new Date().toISOString()} Instructions: 1. Open schema-fix.html and copy the schema to your site's 2. Update your meta description using meta-fix.html 3. Re-run your EkkoScope audit to verify improvements`); const content = await zip.generateAsync({type: "blob"}); const url = URL.createObjectURL(content); const a = document.createElement('a'); a.href = url; a.download = 'ekkoscope-patch-kit.zip'; a.click(); URL.revokeObjectURL(url); } function showGitHubPR() { alert('GitHub PR integration coming soon! Contact support@ekkoscope.com for early access.'); } document.getElementById('deployModal').addEventListener('click', function(e) { if (e.target === this) { closeDeployConsole(); } }); // ================================================================ // STRATEGIST CHAT WIDGET - The Interrogation Room // ================================================================ const businessId = 1; let chatMessages = []; function openStrategist() { document.getElementById('strategistFab').classList.add('hidden'); document.getElementById('strategistPanel').classList.add('active'); } function closeStrategist() { document.getElementById('strategistPanel').classList.remove('active'); document.getElementById('strategistFab').classList.remove('hidden'); } function toggleEvidence(btn) { btn.classList.toggle('expanded'); const list = btn.nextElementSibling; list.classList.toggle('show'); } function addMessage(type, content, evidence = null) { const messagesDiv = document.getElementById('strategistMessages'); const msgDiv = document.createElement('div'); msgDiv.className = `chat-message ${type}`; const avatarSvg = type === 'assistant' ? '' : ''; let bubbleContent = content.replace(/\n/g, '
').replace(/\*\*(.*?)\*\*/g, '$1'); let evidenceHtml = ''; if (evidence && evidence.length > 0) { evidenceHtml = `
Show Evidence (${evidence.length} sources)
`; } msgDiv.innerHTML = `
${avatarSvg}
${bubbleContent}

${evidenceHtml}
`; messagesDiv.appendChild(msgDiv); messagesDiv.scrollTop = messagesDiv.scrollHeight; } function showTyping() { const messagesDiv = document.getElementById('strategistMessages'); const typingDiv = document.createElement('div'); typingDiv.id = 'typingIndicator'; typingDiv.className = 'chat-message assistant'; typingDiv.innerHTML = `
`; messagesDiv.appendChild(typingDiv); messagesDiv.scrollTop = messagesDiv.scrollHeight; } function hideTyping() { const typing = document.getElementById('typingIndicator'); if (typing) typing.remove(); } async function sendStrategistQuery() { const input = document.getElementById('strategistInput'); const sendBtn = document.getElementById('strategistSend'); const query = input.value.trim(); if (!query) return; addMessage('user', query); input.value = ''; sendBtn.disabled = true; showTyping(); try { const response = await fetch('/api/sherlock/consult', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query, business_id: businessId }) }); const data = await response.json(); hideTyping(); if (data.success) { addMessage('assistant', data.answer, data.evidence); } else { addMessage('assistant', data.error || 'I encountered an issue processing your question. Please try again.'); } } catch (err) { hideTyping(); addMessage('assistant', 'Connection error. Please check your network and try again.'); } sendBtn.disabled = false; input.focus(); } document.getElementById('strategistInput').addEventListener('keypress', function(e) { if (e.key === 'Enter') sendStrategistQuery(); }); // ================================================================ // MISSIONS PANEL - Sherlock Generated Missions // ================================================================ async function loadMissions() { const container = document.getElementById('missionsGrid'); const badge = document.getElementById('missionsBadge'); try { const response = await fetch(`/api/sherlock/missions/${businessId}`); const missions = await response.json(); if (!missions || missions.length === 0) { container.innerHTML = `
No missions yet. Run a Sherlock scan to analyze competitors and generate tactical missions.

Run Sherlock Analysis
`; badge.textContent = '0 Pending'; return; } const pending = missions.filter(m => m.status !== 'completed'); badge.textContent = `${pending.length} Pending`; container.innerHTML = missions.map(m => `
${m.priority}
${(m.mission_type || 'content').replace('_', ' ')}
${m.title}
${m.description}
${m.missing_topic || 'General'}
${m.status === 'completed' ? 'Done' : 'Generate Fix'}
`).join(''); } catch (err) { container.innerHTML = '
Failed to load missions. Please refresh.

'; } } async function fabricateFix(missionId, btn) { btn.disabled = true; btn.innerHTML = ' Generating...'; try { const response = await fetch(`/api/sherlock/fabricate/${missionId}`, { method: 'POST', headers: { 'Content-Type': 'application/json' } }); const data = await response.json(); if (data.success && data.files && data.files.length > 0) { const zip = new JSZip(); data.files.forEach(file => { zip.file(file.filename, file.content); }); zip.file("README.txt", `EkkoScope Mission Fix Mission: ${data.mission_title} Business: ${data.business_name} Generated: ${new Date().toISOString()} Files included: ${data.files.map(f => `- ${f.filename}: ${f.description}`).join('\n')} Instructions: 1. Review each generated file 2. Customize content as needed for your brand 3. Upload to your website 4. Run another EkkoScope audit to verify improvements`); const content = await zip.generateAsync({type: "blob"}); const url = URL.createObjectURL(content); const a = document.createElement('a'); a.href = url; a.download = `ekkoscope-mission-${missionId}.zip`; a.click(); URL.revokeObjectURL(url); btn.innerHTML = ' Downloaded!'; setTimeout(() => loadMissions(), 2000); } else { throw new Error(data.error || 'Fabrication failed'); } } catch (err) { btn.innerHTML = 'Generate Fix'; btn.disabled = false; alert('Failed to generate fix: ' + (err.message || 'Unknown error')); } } // Load missions on page load loadMissions();