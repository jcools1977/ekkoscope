<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Center | {{ business.name }} | EkkoScope</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --bg-void: #0B0C15;
            --bg-deep: #0F1119;
            --bg-panel: #14161F;
            --bg-card: #1A1D2D;
            --bg-glass: rgba(20, 22, 31, 0.85);
            --border-glass: rgba(255, 255, 255, 0.08);
            --border-glow: rgba(0, 255, 157, 0.25);
            
            --neon-green: #00FF9D;
            --neon-red: #FF4444;
            --neon-cyan: #00D4FF;
            --ghost-grey: #6B7280;
            
            --text-primary: #F8FAFC;
            --text-secondary: #94A3B8;
            --text-muted: #64748B;
            --text-dim: #475569;
            
            --glow-green: 0 0 30px rgba(0, 255, 157, 0.3);
            --glow-red: 0 0 30px rgba(255, 68, 68, 0.4);
            --glow-cyan: 0 0 20px rgba(0, 212, 255, 0.2);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'JetBrains Mono', monospace;
            background: linear-gradient(180deg, var(--bg-void) 0%, #0D0E17 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Revenue Leak Ticker - Sticky Top */
        .bleed-ticker {
            position: sticky;
            top: 0;
            z-index: 100;
            background: linear-gradient(90deg, rgba(255, 68, 68, 0.15) 0%, rgba(255, 68, 68, 0.08) 50%, rgba(255, 68, 68, 0.15) 100%);
            border-bottom: 1px solid rgba(255, 68, 68, 0.4);
            padding: 0.6rem 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            backdrop-filter: blur(10px);
        }
        
        .bleed-alert {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            animation: alert-pulse 2s ease-in-out infinite;
        }
        
        @keyframes alert-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .bleed-icon {
            color: var(--neon-red);
            font-size: 1rem;
        }
        
        .bleed-label {
            font-size: 0.65rem;
            color: var(--neon-red);
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 600;
        }
        
        .bleed-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--neon-red);
            text-shadow: 0 0 20px rgba(255, 68, 68, 0.6);
            min-width: 100px;
        }
        
        .bleed-rate {
            font-size: 0.6rem;
            color: var(--text-muted);
            padding: 0.2rem 0.5rem;
            background: rgba(255, 68, 68, 0.1);
            border-radius: 4px;
        }
        
        /* Command Center Container */
        .command-center {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        /* Header Bar */
        .header-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1.25rem;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-glass);
            border-radius: 12px;
            margin-bottom: 1rem;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .status-beacon {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .beacon-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--neon-red);
            box-shadow: 0 0 15px var(--neon-red);
            animation: beacon-pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes beacon-pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.5; }
        }
        
        .beacon-dot.nominal { background: var(--neon-green); box-shadow: 0 0 15px var(--neon-green); }
        .beacon-dot.warning { background: #F59E0B; box-shadow: 0 0 15px #F59E0B; }
        
        .status-label {
            font-size: 0.65rem;
            color: var(--neon-red);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .mission-info {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }
        
        .mission-id {
            font-size: 0.55rem;
            color: var(--text-dim);
            letter-spacing: 1px;
        }
        
        .mission-target {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .timestamp-badge {
            font-size: 0.6rem;
            color: var(--text-muted);
            padding: 0.35rem 0.75rem;
            background: rgba(0,0,0,0.4);
            border: 1px solid var(--border-glass);
            border-radius: 6px;
        }
        
        .btn-exit {
            padding: 0.5rem 1rem;
            background: transparent;
            border: 1px solid var(--border-glass);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.65rem;
            text-decoration: none;
            font-family: inherit;
            transition: all 0.2s;
        }
        
        .btn-exit:hover {
            border-color: var(--neon-green);
            color: var(--neon-green);
        }
        
        .btn-settings {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: 1px solid var(--border-glass);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .btn-settings:hover {
            border-color: var(--neon-cyan);
            color: var(--neon-cyan);
        }
        
        .btn-settings svg {
            width: 18px;
            height: 18px;
        }
        
        .settings-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: var(--bg-panel);
            border: 1px solid var(--border-glass);
            border-radius: 12px;
            padding: 0.75rem;
            min-width: 280px;
            display: none;
            z-index: 1000;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }
        
        .settings-dropdown.show {
            display: block;
        }
        
        .settings-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.75rem;
            font-family: inherit;
            cursor: pointer;
            width: 100%;
            text-align: left;
            transition: all 0.2s;
        }
        
        .settings-item:hover {
            background: rgba(0, 212, 255, 0.1);
            border-color: rgba(0, 212, 255, 0.3);
            color: var(--neon-cyan);
        }
        
        .settings-item.warning {
            color: #F59E0B;
        }
        
        .settings-item.warning:hover {
            background: rgba(245, 158, 11, 0.1);
            border-color: rgba(245, 158, 11, 0.3);
        }
        
        .settings-item svg {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }
        
        .settings-item-text {
            flex: 1;
        }
        
        .settings-item-label {
            font-weight: 500;
        }
        
        .settings-item-desc {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 0.2rem;
        }
        
        /* Rescan Modal - Use isolation to create new stacking context */
        .rescan-modal {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            background: rgba(0,0,0,0.95) !important;
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2147483647 !important;
            isolation: isolate;
        }
        
        .rescan-modal.active {
            display: flex !important;
        }
        
        .rescan-terminal {
            background: var(--bg-void);
            border: 1px solid var(--neon-green);
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            overflow: hidden;
            box-shadow: var(--glow-green);
        }
        
        .terminal-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            background: rgba(0, 255, 157, 0.1);
            border-bottom: 1px solid rgba(0, 255, 157, 0.2);
        }
        
        .terminal-dots {
            display: flex;
            gap: 0.4rem;
        }
        
        .terminal-dots span {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .terminal-dots span:nth-child(1) { background: #FF5F56; }
        .terminal-dots span:nth-child(2) { background: #FFBD2E; }
        .terminal-dots span:nth-child(3) { background: #27CA40; }
        
        .terminal-title {
            font-size: 0.75rem;
            color: var(--neon-green);
            font-weight: 600;
            letter-spacing: 1px;
        }
        
        .terminal-body {
            padding: 1.5rem;
            min-height: 300px;
            font-size: 0.8rem;
            color: var(--neon-green);
        }
        
        .terminal-line {
            margin-bottom: 0.5rem;
            opacity: 0;
            animation: terminalFadeIn 0.3s ease forwards;
        }
        
        .terminal-line.prompt::before {
            content: '> ';
            color: var(--neon-cyan);
        }
        
        .terminal-line.success {
            color: var(--neon-green);
        }
        
        .terminal-line.error {
            color: var(--neon-red);
        }
        
        .terminal-line.info {
            color: var(--text-muted);
        }
        
        .terminal-spinner {
            display: inline-block;
            animation: spin 1s linear infinite;
        }
        
        @keyframes terminalFadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .terminal-complete {
            text-align: center;
            padding-top: 1rem;
            border-top: 1px solid rgba(0, 255, 157, 0.2);
            margin-top: 1rem;
        }
        
        .terminal-complete-btn {
            padding: 0.75rem 2rem;
            background: linear-gradient(135deg, var(--neon-green), var(--neon-cyan));
            border: none;
            border-radius: 8px;
            color: var(--bg-void);
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .terminal-complete-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 255, 157, 0.3);
        }
        
        /* Bento Grid Layout */
        .bento-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 1rem;
        }
        
        /* Glass Panel Base */
        .glass-panel {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-glass);
            border-radius: 16px;
            padding: 1.25rem;
            position: relative;
            overflow: hidden;
        }
        
        .glass-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
        }
        
        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .panel-title {
            font-size: 0.6rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .panel-title svg {
            width: 14px;
            height: 14px;
            opacity: 0.5;
        }
        
        .panel-badge {
            font-size: 0.55rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .panel-badge.critical {
            background: rgba(255, 68, 68, 0.15);
            color: var(--neon-red);
            border: 1px solid rgba(255, 68, 68, 0.3);
        }
        
        .panel-badge.live {
            background: rgba(0, 255, 157, 0.1);
            color: var(--neon-green);
            border: 1px solid rgba(0, 255, 157, 0.3);
        }
        
        /* Gap Analysis Chart Panel */
        .gap-analysis-panel {
            grid-column: span 8;
            min-height: 450px;
        }
        
        .chart-wrapper {
            position: relative;
            height: 350px;
        }
        
        .risk-zone-label {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.7rem;
            font-weight: 700;
            color: rgba(255, 68, 68, 0.5);
            text-transform: uppercase;
            letter-spacing: 4px;
            pointer-events: none;
            z-index: 5;
            text-shadow: 0 0 20px rgba(255, 68, 68, 0.3);
        }
        
        .chart-legend {
            display: flex;
            gap: 1.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-glass);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.6rem;
            color: var(--text-secondary);
        }
        
        .legend-line {
            width: 20px;
            height: 3px;
            border-radius: 2px;
        }
        
        .legend-line.user { background: var(--neon-green); }
        .legend-line.leader { background: var(--ghost-grey); border: 1px dashed var(--ghost-grey); height: 0; }
        .legend-line.projected { background: var(--neon-cyan); box-shadow: 0 0 8px var(--neon-cyan); }
        .legend-line.risk { background: linear-gradient(180deg, rgba(255,68,68,0.4), rgba(255,68,68,0.1)); height: 12px; width: 20px; }
        
        /* Tactical Countermeasures Panel */
        .countermeasures-panel {
            grid-column: span 4;
            min-height: 450px;
        }
        
        .projected-display {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: rgba(0, 212, 255, 0.08);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 10px;
            margin-bottom: 1rem;
        }
        
        .projected-label {
            font-size: 0.55rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .projected-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--neon-cyan);
            text-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
        }
        
        .projected-delta {
            font-size: 0.65rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .projected-delta.parity {
            color: var(--neon-green);
            text-shadow: 0 0 10px rgba(0, 255, 157, 0.5);
        }
        
        .target-list {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .target-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-glass);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.25s ease;
        }
        
        .target-item:hover {
            border-color: var(--border-glow);
            background: rgba(0, 255, 157, 0.03);
        }
        
        .target-item.active {
            border-color: var(--neon-green);
            background: rgba(0, 255, 157, 0.08);
            box-shadow: var(--glow-green);
        }
        
        .target-info {
            flex: 1;
        }
        
        .target-name {
            font-size: 0.7rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.2rem;
        }
        
        .target-impact {
            font-size: 0.55rem;
            color: var(--neon-cyan);
        }
        
        .target-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: var(--bg-deep);
            border-radius: 12px;
            border: 1px solid var(--border-glass);
            transition: all 0.3s ease;
        }
        
        .target-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 16px;
            height: 16px;
            background: var(--text-muted);
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .target-item.active .target-switch {
            background: var(--neon-green);
            border-color: var(--neon-green);
            box-shadow: 0 0 15px rgba(0, 255, 157, 0.4);
        }
        
        .target-item.active .target-switch::after {
            left: 23px;
            background: #000;
        }
        
        /* Value Unlocked Floating Badge */
        .value-badge {
            position: fixed;
            padding: 0.6rem 1.25rem;
            background: linear-gradient(135deg, var(--neon-green), #00CC7D);
            color: #000;
            font-weight: 700;
            font-size: 0.75rem;
            border-radius: 8px;
            box-shadow: 0 4px 25px rgba(0, 255, 157, 0.5);
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transform: translateY(15px) scale(0.9);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .value-badge.show {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
        
        /* Competitor Threat Radar */
        .threat-radar-panel {
            grid-column: span 6;
        }
        
        .threat-comparison {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .threat-row {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .threat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .threat-name {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .threat-value {
            font-size: 0.75rem;
            font-weight: 700;
        }
        
        .threat-value.enemy { color: var(--neon-red); }
        .threat-value.friendly { color: var(--neon-green); }
        
        .threat-trend {
            font-size: 0.55rem;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            margin-left: 0.5rem;
        }
        
        .threat-trend.up { background: rgba(255, 68, 68, 0.15); color: var(--neon-red); }
        .threat-trend.down { background: rgba(0, 255, 157, 0.15); color: var(--neon-green); }
        .threat-trend.critical { background: rgba(255, 68, 68, 0.2); color: var(--neon-red); animation: critical-flash 1s infinite; }
        
        @keyframes critical-flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .threat-bar-wrapper {
            height: 28px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }
        
        .threat-bar {
            height: 100%;
            border-radius: 6px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 0.75rem;
        }
        
        .threat-bar.enemy {
            background: linear-gradient(90deg, rgba(255, 68, 68, 0.3), var(--neon-red));
            box-shadow: inset 0 0 20px rgba(255, 68, 68, 0.3);
        }
        
        .threat-bar.friendly {
            background: linear-gradient(90deg, rgba(0, 255, 157, 0.2), var(--neon-green));
            box-shadow: inset 0 0 20px rgba(0, 255, 157, 0.2);
        }
        
        .threat-bar-label {
            font-size: 0.6rem;
            font-weight: 600;
            color: #000;
        }
        
        .gap-indicator {
            margin-top: 1rem;
            padding: 0.75rem 1rem;
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid rgba(255, 68, 68, 0.3);
            border-radius: 8px;
            text-align: center;
        }
        
        .gap-label {
            font-size: 0.55rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.25rem;
        }
        
        .gap-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--neon-red);
            text-shadow: 0 0 15px rgba(255, 68, 68, 0.5);
        }
        
        /* Nuclear Launch Console */
        .launch-console-panel {
            grid-column: span 6;
        }
        
        .console-terminal {
            background: #0A0A0F;
            border: 1px solid rgba(0, 255, 157, 0.2);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .terminal-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1rem;
            background: rgba(0, 255, 157, 0.05);
            border-bottom: 1px solid rgba(0, 255, 157, 0.15);
        }
        
        .terminal-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .terminal-dot.red { background: #FF5F56; }
        .terminal-dot.yellow { background: #FFBD2E; }
        .terminal-dot.green { background: #27C93F; }
        
        .terminal-title {
            font-size: 0.6rem;
            color: var(--neon-green);
            margin-left: 0.5rem;
        }
        
        .terminal-body {
            padding: 1rem;
        }
        
        .agent-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .agent-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.65rem;
        }
        
        .agent-status {
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-size: 0.55rem;
            font-weight: 600;
        }
        
        .agent-status.ready {
            background: rgba(0, 255, 157, 0.15);
            color: var(--neon-green);
        }
        
        .agent-status.standby {
            background: rgba(245, 158, 11, 0.15);
            color: #F59E0B;
        }
        
        .agent-name {
            color: var(--text-secondary);
        }
        
        .agent-version {
            color: var(--text-dim);
            font-size: 0.5rem;
        }
        
        .deploy-btn {
            width: 100%;
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, var(--neon-green), #00CC7D);
            border: none;
            border-radius: 10px;
            color: #000;
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 255, 157, 0.3);
            animation: deploy-pulse 2s ease-in-out infinite;
        }
        
        @keyframes deploy-pulse {
            0%, 100% { box-shadow: 0 4px 20px rgba(0, 255, 157, 0.3); }
            50% { box-shadow: 0 4px 35px rgba(0, 255, 157, 0.5); }
        }
        
        .deploy-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 40px rgba(0, 255, 157, 0.5);
        }
        
        .deploy-btn svg {
            width: 18px;
            height: 18px;
        }
        
        .deploy-subtext {
            font-size: 0.55rem;
            color: var(--text-muted);
            text-align: center;
            margin-top: 0.75rem;
        }
        
        /* Deploy Modal */
        .deploy-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.92);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            backdrop-filter: blur(5px);
        }
        
        .deploy-modal.active { display: flex; }
        
        .deploy-console {
            background: #0a0a0f;
            border: 1px solid rgba(0, 255, 157, 0.3);
            border-radius: 16px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .console-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid rgba(0, 255, 157, 0.2);
            background: rgba(0, 255, 157, 0.03);
        }
        
        .console-modal-title {
            color: var(--neon-green);
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .console-close {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
            line-height: 1;
        }
        
        .console-close:hover { color: var(--text-primary); }
        
        .console-modal-body {
            padding: 1.5rem;
        }
        
        .delivery-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
        
        .delivery-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border-glass);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .delivery-card:hover {
            border-color: var(--neon-green);
            background: rgba(0, 255, 157, 0.05);
            transform: translateY(-4px);
        }
        
        .delivery-card.recommended::after {
            content: 'RECOMMENDED';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.5rem;
            padding: 0.15rem 0.4rem;
            background: var(--neon-green);
            color: #000;
            border-radius: 3px;
            font-weight: 700;
        }
        
        .delivery-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 255, 157, 0.1);
            border-radius: 12px;
            color: var(--neon-green);
        }
        
        .delivery-icon svg {
            width: 24px;
            height: 24px;
        }
        
        .delivery-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        
        .delivery-desc {
            font-size: 0.6rem;
            color: var(--text-muted);
            line-height: 1.5;
        }
        
        /* Intent Breakdown */
        .intent-panel {
            grid-column: span 12;
        }
        
        /* ================================================================
           STRATEGIST CHAT WIDGET - The Interrogation Room
           ================================================================ */
        .strategist-fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--neon-cyan), #0099CC);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 25px rgba(0, 212, 255, 0.4), 0 0 60px rgba(0, 212, 255, 0.2);
            z-index: 1000;
            transition: all 0.3s ease;
            animation: fab-glow 3s ease-in-out infinite;
        }
        
        @keyframes fab-glow {
            0%, 100% { box-shadow: 0 4px 25px rgba(0, 212, 255, 0.4), 0 0 60px rgba(0, 212, 255, 0.2); }
            50% { box-shadow: 0 4px 35px rgba(0, 212, 255, 0.6), 0 0 80px rgba(0, 212, 255, 0.3); }
        }
        
        .strategist-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 35px rgba(0, 212, 255, 0.6);
        }
        
        .strategist-fab svg {
            width: 28px;
            height: 28px;
            color: #fff;
        }
        
        .strategist-fab.hidden { display: none; }
        
        .strategist-panel {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 420px;
            max-height: 600px;
            background: var(--bg-deep);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 16px;
            box-shadow: 0 8px 50px rgba(0, 0, 0, 0.5), 0 0 80px rgba(0, 212, 255, 0.15);
            z-index: 1001;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        
        .strategist-panel.active { display: flex; }
        
        .strategist-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.25rem;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.15), rgba(0, 212, 255, 0.05));
            border-bottom: 1px solid rgba(0, 212, 255, 0.2);
        }
        
        .strategist-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .strategist-title-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--neon-cyan), #0099CC);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .strategist-title-icon svg {
            width: 20px;
            height: 20px;
            color: #fff;
        }
        
        .strategist-title-text h3 {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }
        
        .strategist-title-text span {
            font-size: 0.6rem;
            color: var(--neon-cyan);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .strategist-close {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .strategist-close:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }
        
        .strategist-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-height: 380px;
            min-height: 200px;
        }
        
        .chat-message {
            display: flex;
            gap: 0.75rem;
            animation: message-fade 0.3s ease;
        }
        
        @keyframes message-fade {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .chat-message.user {
            flex-direction: row-reverse;
        }
        
        .chat-avatar {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .chat-message.assistant .chat-avatar {
            background: linear-gradient(135deg, var(--neon-cyan), #0099CC);
        }
        
        .chat-message.user .chat-avatar {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .chat-avatar svg {
            width: 18px;
            height: 18px;
            color: #fff;
        }
        
        .chat-bubble {
            max-width: 85%;
            padding: 0.85rem 1rem;
            border-radius: 12px;
            font-size: 0.75rem;
            line-height: 1.6;
        }
        
        .chat-message.assistant .chat-bubble {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.2);
            color: var(--text-primary);
        }
        
        .chat-message.user .chat-bubble {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
        }
        
        .chat-bubble p { margin: 0 0 0.5rem 0; }
        .chat-bubble p:last-child { margin-bottom: 0; }
        .chat-bubble ul { margin: 0.5rem 0; padding-left: 1.25rem; }
        .chat-bubble li { margin-bottom: 0.25rem; }
        .chat-bubble strong { color: var(--neon-cyan); }
        
        .evidence-toggle {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(0, 212, 255, 0.15);
        }
        
        .evidence-toggle-btn {
            background: transparent;
            border: 1px solid rgba(0, 212, 255, 0.3);
            color: var(--neon-cyan);
            padding: 0.4rem 0.75rem;
            border-radius: 6px;
            font-size: 0.6rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-family: inherit;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s ease;
        }
        
        .evidence-toggle-btn:hover {
            background: rgba(0, 212, 255, 0.1);
        }
        
        .evidence-toggle-btn svg {
            width: 12px;
            height: 12px;
            transition: transform 0.2s ease;
        }
        
        .evidence-toggle-btn.expanded svg {
            transform: rotate(180deg);
        }
        
        .evidence-list {
            display: none;
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }
        
        .evidence-list.show { display: block; }
        
        .evidence-item {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.6rem;
        }
        
        .evidence-item:last-child { border-bottom: none; }
        
        .evidence-type {
            padding: 0.15rem 0.35rem;
            border-radius: 3px;
            font-size: 0.5rem;
            text-transform: uppercase;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .evidence-type.competitor { background: rgba(255, 68, 68, 0.2); color: var(--neon-red); }
        .evidence-type.client { background: rgba(0, 255, 157, 0.2); color: var(--neon-green); }
        .evidence-type.market { background: rgba(0, 212, 255, 0.2); color: var(--neon-cyan); }
        
        .evidence-source {
            color: var(--text-muted);
            word-break: break-all;
        }
        
        .evidence-relevance {
            color: var(--neon-green);
            margin-left: auto;
            flex-shrink: 0;
        }
        
        .chat-typing {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 12px;
            max-width: 120px;
        }
        
        .typing-dot {
            width: 6px;
            height: 6px;
            background: var(--neon-cyan);
            border-radius: 50%;
            animation: typing-bounce 1.2s ease-in-out infinite;
        }
        
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing-bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-6px); }
        }
        
        .strategist-input {
            display: flex;
            gap: 0.75rem;
            padding: 1rem;
            border-top: 1px solid rgba(0, 212, 255, 0.15);
            background: rgba(0, 0, 0, 0.2);
        }
        
        .strategist-input input {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.75rem;
            outline: none;
            transition: all 0.2s ease;
        }
        
        .strategist-input input:focus {
            border-color: rgba(0, 212, 255, 0.5);
            background: rgba(0, 212, 255, 0.05);
        }
        
        .strategist-input input::placeholder {
            color: var(--text-muted);
        }
        
        .strategist-send {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--neon-cyan), #0099CC);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .strategist-send:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.4);
        }
        
        .strategist-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .strategist-send svg {
            width: 20px;
            height: 20px;
            color: #fff;
        }
        
        /* ================================================================
           MISSION CARDS - Sherlock Generated Missions
           ================================================================ */
        .missions-section {
            margin-top: 1rem;
            padding: 1.25rem;
            background: var(--bg-glass);
            border: 1px solid var(--border-glass);
            border-radius: 12px;
        }
        
        .missions-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .missions-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .missions-title-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(255, 68, 68, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--neon-red);
        }
        
        .missions-title h3 {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }
        
        .missions-title span {
            font-size: 0.55rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .missions-badge {
            padding: 0.3rem 0.6rem;
            background: rgba(255, 68, 68, 0.15);
            border: 1px solid rgba(255, 68, 68, 0.3);
            border-radius: 20px;
            font-size: 0.6rem;
            color: var(--neon-red);
            font-weight: 600;
        }
        
        .missions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 0.75rem;
        }
        
        .mission-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-glass);
            border-radius: 10px;
            padding: 1rem;
            transition: all 0.3s ease;
        }
        
        .mission-card:hover {
            border-color: var(--neon-red);
            background: rgba(255, 68, 68, 0.03);
        }
        
        .mission-card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }
        
        .mission-priority {
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.5rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .mission-priority.high {
            background: rgba(255, 68, 68, 0.2);
            color: var(--neon-red);
        }
        
        .mission-priority.medium {
            background: rgba(245, 158, 11, 0.2);
            color: #F59E0B;
        }
        
        .mission-priority.low {
            background: rgba(0, 212, 255, 0.2);
            color: var(--neon-cyan);
        }
        
        .mission-type {
            font-size: 0.5rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .mission-card-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }
        
        .mission-card-desc {
            font-size: 0.65rem;
            color: var(--text-muted);
            line-height: 1.5;
            margin-bottom: 1rem;
        }
        
        .mission-card-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-glass);
        }
        
        .mission-topic {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.55rem;
            color: var(--neon-cyan);
        }
        
        .mission-topic svg {
            width: 12px;
            height: 12px;
        }
        
        .mission-fabricate-btn {
            padding: 0.4rem 0.75rem;
            background: linear-gradient(135deg, var(--neon-green), #00CC7A);
            border: none;
            border-radius: 6px;
            color: #000;
            font-size: 0.55rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-family: inherit;
            transition: all 0.2s ease;
        }
        
        .mission-fabricate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 255, 157, 0.4);
        }
        
        .mission-fabricate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .mission-fabricate-btn svg {
            width: 12px;
            height: 12px;
        }
        
        .missions-empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }
        
        .missions-empty svg {
            width: 48px;
            height: 48px;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
        
        .missions-empty p {
            font-size: 0.7rem;
            margin-bottom: 1rem;
        }
        
        .missions-scan-btn {
            padding: 0.6rem 1.25rem;
            background: rgba(0, 212, 255, 0.15);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 8px;
            color: var(--neon-cyan);
            font-size: 0.65rem;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s ease;
        }
        
        .missions-scan-btn:hover {
            background: rgba(0, 212, 255, 0.25);
        }
        
        .intent-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.75rem;
        }
        
        .intent-card {
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-glass);
            border-radius: 10px;
            text-align: center;
        }
        
        .intent-icon {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }
        
        .intent-label {
            font-size: 0.5rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }
        
        .intent-value {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .intent-rate {
            font-size: 0.55rem;
            margin-top: 0.25rem;
        }
        
        .intent-rate.good { color: var(--neon-green); }
        .intent-rate.bad { color: var(--neon-red); }
        .intent-rate.neutral { color: var(--text-muted); }
        
        /* Footer */
        .command-footer {
            margin-top: 2rem;
            padding: 1rem;
            text-align: center;
            color: var(--text-dim);
            font-size: 0.6rem;
        }
        
        .command-footer a {
            color: var(--neon-green);
            text-decoration: none;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .gap-analysis-panel,
            .countermeasures-panel,
            .threat-radar-panel,
            .launch-console-panel {
                grid-column: span 12;
            }
            .intent-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            .delivery-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .bleed-ticker {
                flex-wrap: wrap;
                justify-content: center;
                gap: 0.5rem;
            }
            .header-bar {
                flex-direction: column;
                gap: 0.75rem;
                align-items: flex-start;
            }
            .header-right {
                width: 100%;
                justify-content: space-between;
            }
            .intent-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Revenue Leak Ticker -->
    <div class="bleed-ticker">
        <div class="bleed-alert">
            <span class="bleed-icon"></span>
            <span class="bleed-label">Critical Alert: Estimated Revenue Leak</span>
        </div>
        <span class="bleed-value" id="bleedValue">-$0.00</span>
        <span class="bleed-rate">/hour</span>
    </div>
    
    <div class="command-center">
        <!-- Header Bar -->
        <div class="header-bar">
            <div class="header-left">
                <div class="status-beacon">
                    <div class="beacon-dot {% if visibility_score < 20 %}{% elif visibility_score < 50 %}warning{% else %}nominal{% endif %}"></div>
                    <span class="status-label">{% if visibility_score < 20 %}CRITICAL{% elif visibility_score < 50 %}WARNING{% else %}NOMINAL{% endif %}</span>
                </div>
                <div class="mission-info">
                    <span class="mission-id">MISSION ID: EKS-{{ audit.id }}-{{ business.id }}</span>
                    <span class="mission-target">{{ business.name }}</span>
                </div>
            </div>
            <div class="header-right">
                <span class="timestamp-badge">{{ audit.completed_at.strftime('%Y-%m-%d %H:%M') if audit.completed_at else 'LIVE' }} UTC</span>
                <div style="position: relative;">
                    <button class="btn-settings" onclick="toggleSettings(event)" title="Settings">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                        </svg>
                    </button>
                    <div class="settings-dropdown" id="settingsDropdown">
                        <button class="settings-item warning" onclick="startRescan()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/>
                            </svg>
                            <div class="settings-item-text">
                                <div class="settings-item-label">Reload Intelligence Data</div>
                                <div class="settings-item-desc">Use if dashboard data appears missing or outdated</div>
                            </div>
                        </button>
                    </div>
                </div>
                <a href="/dashboard/business/{{ business.id }}/audit/{{ audit.id }}" class="btn-exit">Exit</a>
            </div>
        </div>
        
        <!-- Main Bento Grid -->
        <div class="bento-grid">
            
            <!-- Gap Analysis Chart -->
            <div class="glass-panel gap-analysis-panel">
                <div class="panel-header">
                    <span class="panel-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>
                        Gap Analysis Simulator
                    </span>
                    <span class="panel-badge critical">Revenue At Risk</span>
                </div>
                <div class="chart-wrapper">
                    <div class="risk-zone-label">MISSED REVENUE OPPORTUNITY</div>
                    <canvas id="gapChart"></canvas>
                </div>
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-line user"></div>
                        <span>Your Visibility ({{ visibility_score }}%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-line leader"></div>
                        <span>{% if top_competitor %}{{ top_competitor.name }}{% else %}Market Leader{% endif %} ({{ market_leader_score }}%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-line projected"></div>
                        <span>Projected (After Fix)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-line risk"></div>
                        <span>Revenue At Risk Zone</span>
                    </div>
                </div>
            </div>
            
            <!-- Tactical Countermeasures -->
            <div class="glass-panel countermeasures-panel">
                <div class="panel-header">
                    <span class="panel-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                        Tactical Countermeasures
                    </span>
                </div>
                
                <div class="projected-display">
                    <div>
                        <div class="projected-label">Projected Score</div>
                        <div class="projected-value" id="projectedScore">{{ visibility_score }}%</div>
                    </div>
                    <div class="projected-delta" id="projectedDelta">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
                        Toggle actions below
                    </div>
                </div>
                
                <div class="target-list">
                    <div class="target-item" onclick="toggleTarget(this)" data-impact="8" data-value="450">
                        <div class="target-info">
                            <div class="target-name">Inject Schema Markup</div>
                            <div class="target-impact">+8% Visibility | +$450/mo</div>
                        </div>
                        <div class="target-switch"></div>
                    </div>
                    <div class="target-item" onclick="toggleTarget(this)" data-impact="6" data-value="320">
                        <div class="target-info">
                            <div class="target-name">Optimize Meta Descriptions</div>
                            <div class="target-impact">+6% Visibility | +$320/mo</div>
                        </div>
                        <div class="target-switch"></div>
                    </div>
                    <div class="target-item" onclick="toggleTarget(this)" data-impact="10" data-value="580">
                        <div class="target-info">
                            <div class="target-name">Add FAQ Content Blocks</div>
                            <div class="target-impact">+10% Visibility | +$580/mo</div>
                        </div>
                        <div class="target-switch"></div>
                    </div>
                    <div class="target-item" onclick="toggleTarget(this)" data-impact="5" data-value="275">
                        <div class="target-info">
                            <div class="target-name">Fix Page Title Structure</div>
                            <div class="target-impact">+5% Visibility | +$275/mo</div>
                        </div>
                        <div class="target-switch"></div>
                    </div>
                </div>
            </div>
            
            <!-- Competitor Threat Radar -->
            <div class="glass-panel threat-radar-panel">
                <div class="panel-header">
                    <span class="panel-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2a10 10 0 0 1 0 20"/><path d="M12 12l6-6"/></svg>
                        Competitor Threat Radar
                    </span>
                    <span class="panel-badge critical">Gap Detected</span>
                </div>
                
                <div class="threat-comparison">
                    <div class="threat-row">
                        <div class="threat-header">
                            <span class="threat-name">{% if top_competitor %}{{ top_competitor.name }}{% else %}Coastal Roofing{% endif %}</span>
                            <div>
                                <span class="threat-value enemy">{{ market_leader_score }}%</span>
                                <span class="threat-trend up"> Trending Up</span>
                            </div>
                        </div>
                        <div class="threat-bar-wrapper">
                            <div class="threat-bar enemy" style="width: {{ market_leader_score }}%;">
                                <span class="threat-bar-label">{{ market_leader_score }}%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="threat-row">
                        <div class="threat-header">
                            <span class="threat-name">{{ business.name }}</span>
                            <div>
                                <span class="threat-value friendly">{{ visibility_score }}%</span>
                                <span class="threat-trend critical"> Critical</span>
                            </div>
                        </div>
                        <div class="threat-bar-wrapper">
                            <div class="threat-bar friendly" style="width: {{ visibility_score if visibility_score > 0 else 2 }}%;">
                                {% if visibility_score > 5 %}<span class="threat-bar-label">{{ visibility_score }}%</span>{% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="gap-indicator">
                    <div class="gap-label">Market Share Gap</div>
                    <div class="gap-value">-{{ market_leader_score - visibility_score }}%</div>
                </div>
            </div>
            
            <!-- Nuclear Launch Console -->
            <div class="glass-panel launch-console-panel">
                <div class="panel-header">
                    <span class="panel-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
                        Resolution Deployment Console
                    </span>
                    <span class="panel-badge live">Agents Ready</span>
                </div>
                
                <div class="console-terminal">
                    <div class="terminal-header">
                        <div class="terminal-dot red"></div>
                        <div class="terminal-dot yellow"></div>
                        <div class="terminal-dot green"></div>
                        <span class="terminal-title">ekkoscope@deploy:~$</span>
                    </div>
                    <div class="terminal-body">
                        <div class="agent-list">
                            <div class="agent-row">
                                <span class="agent-status ready">[READY]</span>
                                <span class="agent-name">SchemaBot</span>
                                <span class="agent-version">v2.1.4</span>
                            </div>
                            <div class="agent-row">
                                <span class="agent-status ready">[READY]</span>
                                <span class="agent-name">MetaFixer</span>
                                <span class="agent-version">v1.8.2</span>
                            </div>
                            <div class="agent-row">
                                <span class="agent-status ready">[READY]</span>
                                <span class="agent-name">ContentAgent</span>
                                <span class="agent-version">v3.0.1</span>
                            </div>
                            <div class="agent-row">
                                <span class="agent-status standby">[STANDBY]</span>
                                <span class="agent-name">CodePatch</span>
                                <span class="agent-version">v2.4.0</span>
                            </div>
                        </div>
                        
                        <button class="deploy-btn" onclick="openDeployConsole()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                            Deploy Resolution Agents
                        </button>
                        <div class="deploy-subtext">Estimated Time Saved: 42 hours | Value: $1,625/mo</div>
                    </div>
                </div>
            </div>
            
            <!-- Intent Breakdown -->
            <div class="glass-panel intent-panel">
                <div class="panel-header">
                    <span class="panel-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
                        Intent Coverage Matrix
                    </span>
                </div>
                
                <div class="intent-grid">
                    {% for intent_type, data in intent_breakdown.items() %}
                    <div class="intent-card">
                        <div class="intent-icon">
                            {% if 'emergency' in intent_type.lower() %}
                            {% elif 'high' in intent_type.lower() or 'ticket' in intent_type.lower() %}
                            {% elif 'inform' in intent_type.lower() %}
                            {% elif 'transact' in intent_type.lower() %}
                            {% else %}{% endif %}
                        </div>
                        <div class="intent-label">{{ intent_type|replace('_', ' ')|title }}</div>
                        <div class="intent-value">{{ data.found }}/{{ data.total }}</div>
                        {% set rate = (data.found / data.total * 100) if data.total > 0 else 0 %}
                        <div class="intent-rate {% if rate >= 50 %}good{% elif rate > 0 %}neutral{% else %}bad{% endif %}">
                            {{ rate|int }}% Coverage
                        </div>
                    </div>
                    {% endfor %}
                    {% if not intent_breakdown %}
                    <div class="intent-card">
                        <div class="intent-icon"></div>
                        <div class="intent-label">General</div>
                        <div class="intent-value">{{ queries_found }}/{{ total_queries }}</div>
                        <div class="intent-rate {% if visibility_score >= 50 %}good{% elif visibility_score > 0 %}neutral{% else %}bad{% endif %}">
                            {{ visibility_score }}% Coverage
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
        </div>
        
        <!-- Sherlock Missions Section -->
        <div class="missions-section">
            <div class="missions-header">
                <div class="missions-title">
                    <div class="missions-title-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/>
                            <line x1="7" y1="7" x2="7.01" y2="7"/>
                        </svg>
                    </div>
                    <div>
                        <h3>Sherlock Missions</h3>
                        <span>AI-Generated Action Items</span>
                    </div>
                </div>
                <span class="missions-badge" id="missionsBadge">Loading...</span>
            </div>
            <div class="missions-grid" id="missionsGrid">
                <div class="missions-empty">
                    <p>Loading missions...</p>
                </div>
            </div>
        </div>
        
        <div class="command-footer">
            EkkoScope Command Center v4.0 | <a href="https://ekkoscope.com">ekkoscope.com</a>
        </div>
    </div>
    
    <!-- Value Unlocked Badge -->
    <div class="value-badge" id="valueBadge">+$450/mo Value Unlocked</div>
    
    <!-- Deploy Modal -->
    <div class="deploy-modal" id="deployModal">
        <div class="deploy-console">
            <div class="console-modal-header">
                <span class="console-modal-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                    Deployment Options
                </span>
                <button class="console-close" onclick="closeDeployConsole()"></button>
            </div>
            <div class="console-modal-body">
                <div class="delivery-grid">
                    <div class="delivery-card recommended" onclick="copyCodeToClipboard()">
                        <div class="delivery-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                        </div>
                        <div class="delivery-title">Copy Code</div>
                        <div class="delivery-desc">Copy all fixes to clipboard for manual implementation</div>
                    </div>
                    <div class="delivery-card" onclick="downloadPatchKit()">
                        <div class="delivery-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        </div>
                        <div class="delivery-title">Download Patch Kit</div>
                        <div class="delivery-desc">Get a ZIP file with all code patches ready to apply</div>
                    </div>
                    <div class="delivery-card" onclick="showGitHubPR()">
                        <div class="delivery-icon">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                        </div>
                        <div class="delivery-title">GitHub PR</div>
                        <div class="delivery-desc">Create a pull request directly to your repository</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const currentVisibility = {{ visibility_score }};
        const marketLeaderScore = {{ market_leader_score }};
        const topCompetitorName = "{% if top_competitor %}{{ top_competitor.name }}{% else %}Coastal Roofing{% endif %}";
        const businessName = "{{ business.name }}";
        
        let bleedAmount = 0;
        const hourlyLeak = 8.29 + (Math.random() * 2);
        
        function updateBleedTicker() {
            bleedAmount += hourlyLeak / 3600;
            document.getElementById('bleedValue').textContent = '-$' + bleedAmount.toFixed(2);
        }
        
        setInterval(updateBleedTicker, 1000);
        updateBleedTicker();
        
        const ctx = document.getElementById('gapChart').getContext('2d');
        
        const labels = ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Today', '+2 Weeks', '+4 Weeks', '+8 Weeks'];
        const userScoreData = [
            Math.max(0, currentVisibility - 2),
            Math.max(0, currentVisibility - 1),
            currentVisibility,
            currentVisibility,
            currentVisibility,
            currentVisibility,
            currentVisibility,
            currentVisibility
        ];
        const leaderData = Array(8).fill(marketLeaderScore);
        let projectedData = [null, null, null, null, currentVisibility, currentVisibility, currentVisibility, currentVisibility];
        
        const riskFillPlugin = {
            id: 'riskFill',
            beforeDraw: function(chart) {
                const ctx = chart.ctx;
                const chartArea = chart.chartArea;
                const yScale = chart.scales.y;
                
                const yourY = yScale.getPixelForValue(currentVisibility);
                const leaderY = yScale.getPixelForValue(marketLeaderScore);
                
                if (yourY > leaderY) {
                    const gradient = ctx.createLinearGradient(0, leaderY, 0, yourY);
                    gradient.addColorStop(0, 'rgba(255, 68, 68, 0.08)');
                    gradient.addColorStop(0.5, 'rgba(255, 68, 68, 0.15)');
                    gradient.addColorStop(1, 'rgba(255, 68, 68, 0.25)');
                    
                    ctx.save();
                    ctx.fillStyle = gradient;
                    ctx.fillRect(chartArea.left, leaderY, chartArea.right - chartArea.left, yourY - leaderY);
                    ctx.restore();
                }
            }
        };
        
        Chart.register(riskFillPlugin);
        
        const gapChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Your Visibility',
                        data: userScoreData,
                        borderColor: '#00FF9D',
                        backgroundColor: 'rgba(0, 255, 157, 0.1)',
                        fill: false,
                        tension: 0,
                        borderWidth: 3,
                        pointRadius: 5,
                        pointBackgroundColor: '#00FF9D',
                        pointBorderColor: '#00FF9D',
                        pointBorderWidth: 2
                    },
                    {
                        label: topCompetitorName,
                        data: leaderData,
                        borderColor: '#6B7280',
                        borderDash: [8, 4],
                        fill: false,
                        tension: 0,
                        borderWidth: 2,
                        pointRadius: 0
                    },
                    {
                        label: 'Projected',
                        data: projectedData,
                        borderColor: '#00D4FF',
                        backgroundColor: 'rgba(0, 212, 255, 0.15)',
                        fill: true,
                        tension: 0.3,
                        borderWidth: 3,
                        pointRadius: 0,
                        pointHoverRadius: 6
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(10, 10, 15, 0.95)',
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1,
                        padding: 12,
                        displayColors: true,
                        titleFont: { family: 'JetBrains Mono', size: 11 },
                        bodyFont: { family: 'JetBrains Mono', size: 11 },
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + (context.parsed.y !== null ? context.parsed.y + '%' : 'N/A');
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { color: 'rgba(255, 255, 255, 0.03)' },
                        ticks: { 
                            font: { family: 'JetBrains Mono', size: 9 },
                            color: '#64748B'
                        }
                    },
                    y: {
                        min: 0,
                        max: Math.max(100, marketLeaderScore + 15),
                        grid: { color: 'rgba(255, 255, 255, 0.03)' },
                        ticks: {
                            font: { family: 'JetBrains Mono', size: 9 },
                            color: '#64748B',
                            callback: function(value) { return value + '%'; }
                        }
                    }
                },
                animation: {
                    duration: 800,
                    easing: 'easeOutQuart'
                }
            }
        });
        
        let activeImpact = 0;
        let activeCount = 0;
        const totalTargets = document.querySelectorAll('.target-item').length;
        const valueBadge = document.getElementById('valueBadge');
        const projectedScoreEl = document.getElementById('projectedScore');
        const projectedDeltaEl = document.getElementById('projectedDelta');
        
        function toggleTarget(element) {
            element.classList.toggle('active');
            const impact = parseInt(element.dataset.impact) || 0;
            const value = parseInt(element.dataset.value) || 0;
            
            if (element.classList.contains('active')) {
                activeImpact += impact;
                activeCount++;
                showValueBadge(element, value);
            } else {
                activeImpact -= impact;
                activeCount--;
            }
            
            const projectedScore = Math.min(100, currentVisibility + activeImpact);
            projectedScoreEl.textContent = projectedScore + '%';
            
            if (activeCount === totalTargets && projectedScore >= marketLeaderScore) {
                projectedDeltaEl.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg> +' + activeImpact + '% (PARITY ACHIEVED)';
                projectedDeltaEl.classList.add('parity');
            } else if (activeImpact > 0) {
                projectedDeltaEl.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19V5M5 12l7-7 7 7"/></svg> +' + activeImpact + '% projected gain';
                projectedDeltaEl.classList.remove('parity');
            } else {
                projectedDeltaEl.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19V5M5 12l7-7 7 7"/></svg> Toggle actions above';
                projectedDeltaEl.classList.remove('parity');
            }
            
            const newProjected = [null, null, null, null, currentVisibility,
                Math.min(100, currentVisibility + activeImpact * 0.4),
                Math.min(100, currentVisibility + activeImpact * 0.7),
                Math.min(100, projectedScore)
            ];
            
            gapChart.data.datasets[2].data = newProjected;
            gapChart.update('default');
        }
        
        function showValueBadge(element, value) {
            const rect = element.getBoundingClientRect();
            valueBadge.textContent = '+$' + value + '/mo Value Unlocked';
            valueBadge.style.left = (rect.left + rect.width / 2 - 100) + 'px';
            valueBadge.style.top = (rect.top - 55) + 'px';
            valueBadge.classList.add('show');
            
            setTimeout(() => {
                valueBadge.classList.remove('show');
            }, 2500);
        }
        
        function openDeployConsole() {
            document.getElementById('deployModal').classList.add('active');
        }
        
        function closeDeployConsole() {
            document.getElementById('deployModal').classList.remove('active');
        }
        
        function copyCodeToClipboard() {
            const code = `<!-- EkkoScope Schema Fix for ${businessName} -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "LocalBusiness",
  "name": "${businessName}",
  "description": "Professional services optimized for AI visibility",
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "4.9",
    "reviewCount": "127"
  }
}
<` + `/script>

<!-- Meta Description Fix -->
<meta name="description" content="Professional ${businessName} services. Available 24/7 for emergency needs. Top-rated with 4.9 reviews.">

<!-- FAQ Schema -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [{
    "@type": "Question",
    "name": "Why choose ${businessName}?",
    "acceptedAnswer": {
      "@type": "Answer",
      "text": "We provide expert services with 24/7 availability and industry-leading response times."
    }
  }]
}
<` + `/script>`;
            
            navigator.clipboard.writeText(code).then(() => {
                alert('Code copied to clipboard!');
            });
        }
        
        async function downloadPatchKit() {
            const zip = new JSZip();
            
            zip.file("schema-fix.html", `<!-- LocalBusiness Schema for ${businessName} -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "LocalBusiness",
  "name": "${businessName}"
}
<` + `/script>`);
            
            zip.file("meta-fix.html", `<meta name="description" content="Professional ${businessName} services.">`);
            
            zip.file("README.txt", `EkkoScope Patch Kit for ${businessName}
Generated: ${new Date().toISOString()}

Instructions:
1. Open schema-fix.html and copy the schema to your site's head section
2. Update your meta description using meta-fix.html
3. Re-run your EkkoScope audit to verify improvements`);
            
            const content = await zip.generateAsync({type: "blob"});
            const url = URL.createObjectURL(content);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ekkoscope-patch-kit.zip';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function showGitHubPR() {
            alert('GitHub PR integration coming soon! Contact support@ekkoscope.com for early access.');
        }
        
        document.getElementById('deployModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDeployConsole();
            }
        });
        
        // ================================================================
        // STRATEGIST CHAT WIDGET - The Interrogation Room
        // ================================================================
        const businessId = {{ business.id }};
        let chatMessages = [];
        
        function openStrategist() {
            document.getElementById('strategistFab').classList.add('hidden');
            document.getElementById('strategistPanel').classList.add('active');
        }
        
        function closeStrategist() {
            document.getElementById('strategistPanel').classList.remove('active');
            document.getElementById('strategistFab').classList.remove('hidden');
        }
        
        function toggleEvidence(btn) {
            btn.classList.toggle('expanded');
            const list = btn.nextElementSibling;
            list.classList.toggle('show');
        }
        
        function addMessage(type, content, evidence = null) {
            const messagesDiv = document.getElementById('strategistMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `chat-message ${type}`;
            
            const avatarSvg = type === 'assistant' 
                ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'
                : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>';
            
            let bubbleContent = content.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            let evidenceHtml = '';
            if (evidence && evidence.length > 0) {
                evidenceHtml = `
                <div class="evidence-toggle">
                    <button class="evidence-toggle-btn" onclick="toggleEvidence(this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                        Show Evidence (${evidence.length} sources)
                    </button>
                    <div class="evidence-list">
                        ${evidence.map(e => `
                            <div class="evidence-item">
                                <span class="evidence-type ${e.type || 'market'}">${e.type || 'source'}</span>
                                <span class="evidence-source">${e.title || e.source}</span>
                                <span class="evidence-relevance">${Math.round(e.relevance * 100)}%</span>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            }
            
            msgDiv.innerHTML = `
                <div class="chat-avatar">${avatarSvg}</div>
                <div class="chat-bubble">
                    <p>${bubbleContent}</p>
                    ${evidenceHtml}
                </div>
            `;
            
            messagesDiv.appendChild(msgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function showTyping() {
            const messagesDiv = document.getElementById('strategistMessages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'chat-message assistant';
            typingDiv.innerHTML = `
                <div class="chat-avatar">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                </div>
                <div class="chat-typing">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            messagesDiv.appendChild(typingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function hideTyping() {
            const typing = document.getElementById('typingIndicator');
            if (typing) typing.remove();
        }
        
        async function sendStrategistQuery() {
            const input = document.getElementById('strategistInput');
            const sendBtn = document.getElementById('strategistSend');
            const query = input.value.trim();
            
            if (!query) return;
            
            addMessage('user', query);
            input.value = '';
            sendBtn.disabled = true;
            showTyping();
            
            try {
                const response = await fetch('/api/sherlock/consult', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, business_id: businessId })
                });
                
                hideTyping();
                
                if (response.status === 500 || response.status === 503) {
                    addMessage('assistant', '**Intelligence Index Missing**\n\nThe semantic analysis data for this account has not been initialized or has become corrupted.\n\nPlease click the **Settings gear icon** in the top right corner and select **"Reload Intelligence Data"** to initialize this account\'s intelligence index.');
                    sendBtn.disabled = false;
                    input.focus();
                    return;
                }
                
                const data = await response.json();
                
                if (data.success) {
                    addMessage('assistant', data.answer, data.evidence);
                } else if (data.error && (data.error.includes('not enabled') || data.error.includes('not initialized') || data.error.includes('No client content'))) {
                    addMessage('assistant', '**Intelligence Index Missing**\n\nThe semantic analysis data for this account has not been initialized.\n\nPlease click the **Settings gear icon** in the top right corner and select **"Reload Intelligence Data"** to initialize this account\'s intelligence index.');
                } else {
                    addMessage('assistant', data.error || 'I encountered an issue processing your question. Please try again.');
                }
            } catch (err) {
                hideTyping();
                if (err.message && err.message.includes('500')) {
                    addMessage('assistant', '**Intelligence Index Missing**\n\nConnection error occurred. Please click the **Settings gear icon** and select **"Reload Intelligence Data"** to initialize this account.');
                } else {
                    addMessage('assistant', 'Connection error. Please check your network and try again.');
                }
            }
            
            sendBtn.disabled = false;
            input.focus();
        }
        
        const strategistInputEl = document.getElementById('strategistInput');
        if (strategistInputEl) {
            strategistInputEl.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendStrategistQuery();
            });
        }
        
        // ================================================================
        // MISSIONS PANEL - Sherlock Generated Missions
        // ================================================================
        async function loadMissions() {
            const container = document.getElementById('missionsGrid');
            const badge = document.getElementById('missionsBadge');
            
            try {
                const response = await fetch(`/api/sherlock/missions/${businessId}`);
                const missions = await response.json();
                
                if (!missions || missions.length === 0) {
                    container.innerHTML = `
                        <div class="missions-empty">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
                            <p>No missions yet. Run a Sherlock scan to analyze competitors and generate tactical missions.</p>
                            <button class="missions-scan-btn" onclick="window.location.href='/dashboard/${businessId}/sherlock'">Run Sherlock Analysis</button>
                        </div>
                    `;
                    badge.textContent = '0 Pending';
                    return;
                }
                
                const pending = missions.filter(m => m.status !== 'completed');
                badge.textContent = `${pending.length} Pending`;
                
                container.innerHTML = missions.map(m => `
                    <div class="mission-card" data-id="${m.id}">
                        <div class="mission-card-header">
                            <span class="mission-priority ${m.priority}">${m.priority}</span>
                            <span class="mission-type">${(m.mission_type || 'content').replace('_', ' ')}</span>
                        </div>
                        <div class="mission-card-title">${m.title}</div>
                        <div class="mission-card-desc">${m.description}</div>
                        <div class="mission-card-footer">
                            <div class="mission-topic">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
                                ${m.missing_topic || 'General'}
                            </div>
                            <button class="mission-fabricate-btn" onclick="fabricateFix(${m.id}, this)" ${m.status === 'completed' ? 'disabled' : ''}>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
                                ${m.status === 'completed' ? 'Done' : 'Generate Fix'}
                            </button>
                        </div>
                    </div>
                `).join('');
                
            } catch (err) {
                container.innerHTML = '<div class="missions-empty"><p>Failed to load missions. Please refresh.</p></div>';
            }
        }
        
        async function fabricateFix(missionId, btn) {
            btn.disabled = true;
            btn.innerHTML = '<svg class="spinner" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="60" stroke-linecap="round"><animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s" repeatCount="indefinite"/></circle></svg> Generating...';
            
            try {
                const response = await fetch(`/api/sherlock/fabricate/${missionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success && data.files && data.files.length > 0) {
                    const zip = new JSZip();
                    
                    data.files.forEach(file => {
                        zip.file(file.filename, file.content);
                    });
                    
                    zip.file("README.txt", `EkkoScope Mission Fix
Mission: ${data.mission_title}
Business: ${data.business_name}
Generated: ${new Date().toISOString()}

Files included:
${data.files.map(f => `- ${f.filename}: ${f.description}`).join('\n')}

Instructions:
1. Review each generated file
2. Customize content as needed for your brand
3. Upload to your website
4. Run another EkkoScope audit to verify improvements`);
                    
                    const content = await zip.generateAsync({type: "blob"});
                    const url = URL.createObjectURL(content);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `ekkoscope-mission-${missionId}.zip`;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Downloaded!';
                    setTimeout(() => loadMissions(), 2000);
                } else {
                    throw new Error(data.error || 'Fabrication failed');
                }
            } catch (err) {
                btn.innerHTML = 'Generate Fix';
                btn.disabled = false;
                alert('Failed to generate fix: ' + (err.message || 'Unknown error'));
            }
        }
        
        // Load missions on page load
        loadMissions();
    </script>
    
    <script>
        // Settings dropdown toggle
        function toggleSettings(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('settingsDropdown');
            dropdown.classList.toggle('show');
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('settingsDropdown');
            const settingsBtn = document.querySelector('.btn-settings');
            if (!settingsBtn.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });
        
        // Rescan functionality - uses businessId from strategist section
        let terminalLineDelay = 0;
        
        function addTerminalLine(text, className = '') {
            const body = document.getElementById('terminalBody');
            const line = document.createElement('div');
            line.className = `terminal-line ${className}`;
            line.innerHTML = text;
            line.style.animationDelay = `${terminalLineDelay}s`;
            terminalLineDelay += 0.15;
            body.appendChild(line);
            body.scrollTop = body.scrollHeight;
        }
        
        function clearTerminal() {
            document.getElementById('terminalBody').innerHTML = '';
            terminalLineDelay = 0;
        }
        
        async function startRescan() {
            // Hide settings dropdown
            document.getElementById('settingsDropdown').classList.remove('show');
            
            // Show modal - ensure it's at body level (portal pattern)
            const modal = document.getElementById('rescanModal');
            if (modal.parentElement !== document.body) {
                document.body.appendChild(modal);
            }
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Clear and start terminal output
            clearTerminal();
            
            addTerminalLine('Initializing Sherlock Intelligence Rescan...', 'prompt');
            addTerminalLine('Target: {{ business.name }}', 'info');
            addTerminalLine('Domain: {{ business.primary_domain }}', 'info');
            addTerminalLine('');
            
            await sleep(500);
            addTerminalLine('PHASE 1: Clearing existing vectors...', 'prompt');
            
            try {
                const formData = new FormData();
                formData.append('business_id', businessId);
                
                const response = await fetch('/api/sherlock/rescan', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    await sleep(300);
                    addTerminalLine('Vectors cleared: ' + (data.cleared?.vectors_deleted || 0), 'success');
                    addTerminalLine('Database records purged', 'success');
                    addTerminalLine('');
                    
                    await sleep(400);
                    addTerminalLine('PHASE 2: Re-ingesting client content...', 'prompt');
                    await sleep(600);
                    addTerminalLine('Scraping https://{{ business.primary_domain }}...', 'info');
                    await sleep(500);
                    addTerminalLine('Extracting semantic topics...', 'info');
                    await sleep(400);
                    addTerminalLine('Generating embeddings...', 'info');
                    await sleep(300);
                    addTerminalLine('Client content ingested', 'success');
                    addTerminalLine('');
                    
                    await sleep(400);
                    addTerminalLine('PHASE 3: Running gap analysis...', 'prompt');
                    await sleep(500);
                    if (data.analysis?.gap_analysis?.success) {
                        const gaps = data.analysis.gap_analysis.missing_topics?.length || 0;
                        addTerminalLine('Gap analysis complete: ' + gaps + ' missing topics identified', 'success');
                    } else {
                        addTerminalLine('Gap analysis ready (awaiting competitor data)', 'info');
                    }
                    addTerminalLine('');
                    
                    await sleep(400);
                    addTerminalLine('PHASE 4: Generating missions...', 'prompt');
                    await sleep(400);
                    const missionCount = data.analysis?.missions?.length || 0;
                    addTerminalLine('Missions generated: ' + missionCount, 'success');
                    addTerminalLine('');
                    
                    await sleep(500);
                    addTerminalLine('='.repeat(40), 'success');
                    addTerminalLine('INTELLIGENCE RESCAN COMPLETE', 'success');
                    addTerminalLine('='.repeat(40), 'success');
                    
                    // Add complete button
                    await sleep(600);
                    const completeDiv = document.createElement('div');
                    completeDiv.className = 'terminal-complete';
                    completeDiv.innerHTML = '<button class="terminal-complete-btn" onclick="closeRescanAndReload()">Reload Dashboard</button>';
                    document.getElementById('terminalBody').appendChild(completeDiv);
                    
                } else {
                    addTerminalLine('ERROR: ' + (data.error || 'Rescan failed'), 'error');
                    addTerminalLine('');
                    addTerminalLine('Click outside to close', 'info');
                }
                
            } catch (err) {
                addTerminalLine('CONNECTION ERROR: ' + err.message, 'error');
                addTerminalLine('');
                addTerminalLine('Click outside to close', 'info');
            }
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        function closeRescanAndReload() {
            document.getElementById('rescanModal').classList.remove('active');
            document.body.style.overflow = '';
            window.location.reload();
        }
        
        function closeRescanModal() {
            document.getElementById('rescanModal').classList.remove('active');
            document.body.style.overflow = '';
        }
        
        // Close modal on outside click
        const rescanModalEl = document.getElementById('rescanModal');
        if (rescanModalEl) {
            rescanModalEl.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeRescanModal();
                }
            });
        }
    </script>
    
    <!-- Strategist FAB Button -->
    <button class="strategist-fab" id="strategistFab" onclick="openStrategist()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
    </button>
    
    <!-- Strategist Chat Panel -->
    <div class="strategist-panel" id="strategistPanel">
        <div class="strategist-header">
            <div class="strategist-title">
                <div class="strategist-title-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                </div>
                <div class="strategist-title-text">
                    <h3>Ask the Strategist</h3>
                    <span>RAG-Powered Intelligence</span>
                </div>
            </div>
            <button class="strategist-close" onclick="closeStrategist()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="strategist-messages" id="strategistMessages">
            <div class="chat-message assistant">
                <div class="chat-avatar">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                </div>
                <div class="chat-bubble">
                    <p>Hello! I'm your AI Visibility Strategist. I analyze competitor data to help you win more AI recommendations.</p>
                    <p>Try asking:</p>
                    <ul>
                        <li>"Why is [competitor] beating me?"</li>
                        <li>"What topics am I missing?"</li>
                        <li>"How can I improve my visibility?"</li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="strategist-input">
            <input type="text" id="strategistInput" placeholder="Ask about your competitors..." autocomplete="off">
            <button class="strategist-send" id="strategistSend" onclick="sendStrategistQuery()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="22" y1="2" x2="11" y2="13"/>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                </svg>
            </button>
        </div>
    </div>
    
    <!-- Rescan Modal - Must be at body level for proper z-index -->
    <div class="rescan-modal" id="rescanModal">
        <div class="rescan-terminal">
            <div class="terminal-header">
                <div class="terminal-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <span class="terminal-title">SHERLOCK INTELLIGENCE RESCAN</span>
            </div>
            <div class="terminal-body" id="terminalBody">
                <!-- Terminal output will be appended here -->
            </div>
        </div>
    </div>
</body>
</html>
