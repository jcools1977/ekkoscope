{% extends "admin/base.html" %}

{% block title %}{{ business.name }} - EchoScope Admin{% endblock %}

{% block content %}
<style>
    .plan-badge {
        display: inline-block;
        padding: 0.35rem 0.75rem;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    .plan-snapshot { background: rgba(100, 116, 139, 0.2); color: #94a3b8; }
    .plan-ongoing { background: rgba(46, 230, 168, 0.2); color: var(--brand-teal); }
    .sub-active { background: rgba(46, 230, 168, 0.15); color: var(--brand-teal); border: 1px solid rgba(46, 230, 168, 0.3); }
    .sub-inactive { background: rgba(100, 116, 139, 0.1); color: #64748b; }
    .btn-secondary {
        background: transparent;
        border: 1px solid var(--brand-teal);
        color: var(--brand-teal);
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
    }
    .btn-secondary:hover {
        background: rgba(46, 230, 168, 0.1);
    }
    .actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-top: 1.5rem;
    }
</style>

<div class="page-header">
    <h1>{{ business.name }}</h1>
    <p>Business details and audit history</p>
</div>

<div class="card">
    <div class="card-header">
        <h2>Business Profile</h2>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <span class="plan-badge plan-{{ business.plan or 'snapshot' }}">{{ business.plan or 'snapshot' }}</span>
            <span class="status-badge {% if business.source == 'admin' %}status-done{% else %}status-pending{% endif %}">{{ business.source }}</span>
        </div>
    </div>
    
    <div class="detail-grid">
        <div class="detail-item">
            <div class="label">Primary Domain</div>
            <div class="value">{{ business.primary_domain }}</div>
        </div>
        <div class="detail-item">
            <div class="label">Business Type</div>
            <div class="value">{{ business.business_type }}</div>
        </div>
        <div class="detail-item">
            <div class="label">Extra Domains</div>
            <div class="value">{{ business.extra_domains | join(', ') if business.extra_domains else '-' }}</div>
        </div>
        <div class="detail-item">
            <div class="label">Regions</div>
            <div class="value">{{ business.regions | join(', ') if business.regions else '-' }}</div>
        </div>
        <div class="detail-item">
            <div class="label">Categories</div>
            <div class="value">{{ business.categories | join(', ') if business.categories else '-' }}</div>
        </div>
        <div class="detail-item">
            <div class="label">Contact</div>
            <div class="value">{{ business.contact_name or '-' }} {% if business.contact_email %}({{ business.contact_email }}){% endif %}</div>
        </div>
        <div class="detail-item">
            <div class="label">Created</div>
            <div class="value">{{ business.created_at.strftime('%Y-%m-%d %H:%M') if business.created_at else '-' }}</div>
        </div>
        <div class="detail-item">
            <div class="label">Plan</div>
            <div class="value">
                <span class="plan-badge plan-{{ business.plan or 'snapshot' }}">{{ business.plan or 'snapshot' }}</span>
            </div>
        </div>
        <div class="detail-item">
            <div class="label">Subscription</div>
            <div class="value">
                {% if business.subscription_active %}
                <span class="plan-badge sub-active">Active</span>
                {% else %}
                <span class="plan-badge sub-inactive">Inactive</span>
                {% endif %}
            </div>
        </div>
        {% if business.stripe_subscription_id %}
        <div class="detail-item">
            <div class="label">Stripe Subscription</div>
            <div class="value" style="font-family: monospace; font-size: 0.85rem;">{{ business.stripe_subscription_id }}</div>
        </div>
        {% endif %}
    </div>
    
    <div class="actions">
        <form method="POST" action="/admin/business/{{ business.id }}/run" style="display: inline;">
            <button type="submit" class="btn btn-primary">Run EchoScope Audit (Admin)</button>
        </form>
        {% if business.subscription_active and (business.plan == 'ongoing') %}
        <form method="POST" action="/admin/business/{{ business.id }}/refresh" style="display: inline;">
            <button type="submit" class="btn btn-secondary">Run Monthly Refresh Audit</button>
        </form>
        {% endif %}
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2>Audit History</h2>
    </div>
    
    {% if audits %}
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Channel</th>
                <th>Status</th>
                <th>Site Inspector</th>
                <th>Created</th>
                <th>Completed</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for audit in audits %}
            <tr>
                <td>#{{ audit.id }}</td>
                <td>{{ audit.channel }}</td>
                <td><span class="status-badge status-{{ audit.status }}">{{ audit.status }}</span></td>
                <td>{% if audit.site_inspector_used %}Yes{% else %}No{% endif %}</td>
                <td>{{ audit.created_at.strftime('%Y-%m-%d %H:%M') if audit.created_at else '-' }}</td>
                <td>{{ audit.completed_at.strftime('%Y-%m-%d %H:%M') if audit.completed_at else '-' }}</td>
                <td>
                    <a href="/admin/audit/{{ audit.id }}">View</a>
                    {% if audit.has_pdf %} | <a href="/admin/audit/{{ audit.id }}/download">PDF</a>{% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <p>No audits for this business yet.</p>
    </div>
    {% endif %}
</div>
{% endblock %}
