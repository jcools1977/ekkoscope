{% extends "admin/base.html" %}

{% block title %}{{ business.name }} - EkkoScope Admin{% endblock %}

{% block content %}
<style>
    .plan-badge {
        display: inline-block;
        padding: 0.35rem 0.75rem;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    .plan-snapshot { background: rgba(100, 116, 139, 0.2); color: #94a3b8; }
    .plan-ongoing { background: rgba(46, 230, 168, 0.2); color: var(--brand-teal); }
    .sub-active { background: rgba(46, 230, 168, 0.15); color: var(--brand-teal); border: 1px solid rgba(46, 230, 168, 0.3); }
    .sub-inactive { background: rgba(100, 116, 139, 0.1); color: #64748b; }
    .btn-secondary {
        background: transparent;
        border: 1px solid var(--brand-teal);
        color: var(--brand-teal);
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
    }
    .btn-secondary:hover {
        background: rgba(46, 230, 168, 0.1);
    }
    .actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-top: 1.5rem;
    }
</style>

<div class="page-header">
    <h1>{{ business.name }}</h1>
    <p>Business details and audit history</p>
</div>

<div class="card">
    <div class="card-header">
        <h2>Business Profile</h2>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <span class="plan-badge plan-{{ business.plan or 'snapshot' }}">{{ business.plan or 'snapshot' }}</span>
            <span class="status-badge {% if business.source == 'admin' %}status-done{% else %}status-pending{% endif %}">{{ business.source }}</span>
        </div>
    </div>
    
    <div class="detail-grid">
        <div class="detail-item">
            <div class="label">Primary Domain</div>
            <div class="value">{{ business.primary_domain }}</div>
        </div>
        <div class="detail-item">
            <div class="label">Business Type</div>
            <div class="value">{{ business.business_type }}</div>
        </div>
        <div class="detail-item">
            <div class="label">Extra Domains</div>
            <div class="value">{{ business.extra_domains | join(', ') if business.extra_domains else '-' }}</div>
        </div>
        <div class="detail-item">
            <div class="label">Regions</div>
            <div class="value">{{ business.regions | join(', ') if business.regions else '-' }}</div>
        </div>
        <div class="detail-item">
            <div class="label">Categories</div>
            <div class="value">{{ business.categories | join(', ') if business.categories else '-' }}</div>
        </div>
        <div class="detail-item">
            <div class="label">Contact</div>
            <div class="value">{{ business.contact_name or '-' }} {% if business.contact_email %}({{ business.contact_email }}){% endif %}</div>
        </div>
        <div class="detail-item">
            <div class="label">Created</div>
            <div class="value">{{ business.created_at.strftime('%Y-%m-%d %H:%M') if business.created_at else '-' }}</div>
        </div>
        <div class="detail-item">
            <div class="label">Plan</div>
            <div class="value">
                <span class="plan-badge plan-{{ business.plan or 'snapshot' }}">{{ business.plan or 'snapshot' }}</span>
            </div>
        </div>
        <div class="detail-item">
            <div class="label">Subscription</div>
            <div class="value">
                {% if business.subscription_active %}
                <span class="plan-badge sub-active">Active</span>
                {% else %}
                <span class="plan-badge sub-inactive">Inactive</span>
                {% endif %}
            </div>
        </div>
        {% if business.stripe_subscription_id %}
        <div class="detail-item">
            <div class="label">Stripe Subscription</div>
            <div class="value" style="font-family: monospace; font-size: 0.85rem;">{{ business.stripe_subscription_id }}</div>
        </div>
        {% endif %}
    </div>
    
    <div class="actions">
        <a href="/admin/business/{{ business.id }}/mission" class="btn btn-secondary" style="background: linear-gradient(135deg, #00E5A0, #18A3FF); color: #000; border: none; padding: 0.75rem 1.5rem; font-weight: 600;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.5rem; vertical-align: middle;">
                <circle cx="12" cy="12" r="10"></circle>
                <circle cx="12" cy="12" r="6"></circle>
                <circle cx="12" cy="12" r="2"></circle>
            </svg>
            Mission Control
        </a>
        <form method="POST" action="/admin/business/{{ business.id }}/run" style="display: inline;" class="audit-form">
            <button type="submit" class="radar-button">
                <svg class="radar-icon" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="radarGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#2EE6A8"/>
                            <stop offset="100%" style="stop-color:#18A3FF"/>
                        </linearGradient>
                    </defs>
                    <g class="radar-grid">
                        <circle cx="40" cy="40" r="35" fill="none" stroke="url(#radarGrad)" stroke-width="1.5" opacity="0.3"/>
                        <circle cx="40" cy="40" r="25" fill="none" stroke="url(#radarGrad)" stroke-width="1.2" opacity="0.4"/>
                        <circle cx="40" cy="40" r="15" fill="none" stroke="url(#radarGrad)" stroke-width="1" opacity="0.5"/>
                    </g>
                    <g class="radar-sweep">
                        <path d="M 40 40 L 40 5 A 35 35 0 0 1 72 55 Z" fill="url(#radarGrad)" opacity="0.15"/>
                    </g>
                    <g class="radar-arcs">
                        <path d="M 52 32 A 15 15 0 0 1 52 48" fill="none" stroke="#2EE6A8" stroke-width="2.5" stroke-linecap="round" opacity="0.9"/>
                        <path d="M 58 26 A 22 22 0 0 1 58 54" fill="none" stroke="#2EE6A8" stroke-width="2" stroke-linecap="round" opacity="0.6"/>
                    </g>
                    <circle class="radar-center" cx="40" cy="40" r="5" fill="url(#radarGrad)"/>
                    <circle class="radar-pulse" cx="40" cy="40" r="5" fill="none" stroke="#2EE6A8" stroke-width="1.5" opacity="0.8"/>
                </svg>
                <span class="radar-text">Run Audit</span>
                <span class="radar-loading-text">Running...</span>
            </button>
        </form>
        {% if business.subscription_active and (business.plan == 'ongoing') %}
        <form method="POST" action="/admin/business/{{ business.id }}/refresh" style="display: inline;" class="audit-form">
            <button type="submit" class="radar-button">
                <svg class="radar-icon" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="radarGrad2" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#2EE6A8"/>
                            <stop offset="100%" style="stop-color:#18A3FF"/>
                        </linearGradient>
                    </defs>
                    <g class="radar-grid">
                        <circle cx="40" cy="40" r="35" fill="none" stroke="url(#radarGrad2)" stroke-width="1.5" opacity="0.3"/>
                        <circle cx="40" cy="40" r="25" fill="none" stroke="url(#radarGrad2)" stroke-width="1.2" opacity="0.4"/>
                    </g>
                    <g class="radar-sweep">
                        <path d="M 40 40 L 40 5 A 35 35 0 0 1 72 55 Z" fill="url(#radarGrad2)" opacity="0.15"/>
                    </g>
                    <circle class="radar-center" cx="40" cy="40" r="5" fill="url(#radarGrad2)"/>
                </svg>
                <span class="radar-text">Refresh Audit</span>
                <span class="radar-loading-text">Running...</span>
            </button>
        </form>
        {% endif %}
        <a href="/admin/business/{{ business.id }}/edit" class="btn btn-secondary">Edit Business</a>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2>Audit History</h2>
    </div>
    
    {% if audits %}
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Channel</th>
                <th>Status</th>
                <th>Site Inspector</th>
                <th>Created</th>
                <th>Completed</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for audit in audits %}
            <tr>
                <td>#{{ audit.id }}</td>
                <td>{{ audit.channel }}</td>
                <td><span class="status-badge status-{{ audit.status }}">{{ audit.status }}</span></td>
                <td>{% if audit.site_inspector_used %}Yes{% else %}No{% endif %}</td>
                <td>{{ audit.created_at.strftime('%Y-%m-%d %H:%M') if audit.created_at else '-' }}</td>
                <td>{{ audit.completed_at.strftime('%Y-%m-%d %H:%M') if audit.completed_at else '-' }}</td>
                <td>
                    <a href="/admin/audit/{{ audit.id }}">View</a>
                    {% if audit.has_pdf %} | <a href="/admin/audit/{{ audit.id }}/download">PDF</a>{% endif %}
                    | <form method="POST" action="/admin/audit/{{ audit.id }}/delete" style="display:inline;" onsubmit="return confirm('Delete this audit? This cannot be undone.');">
                        <button type="submit" class="btn-delete">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <p>No audits for this business yet.</p>
    </div>
    {% endif %}
</div>

<script>
document.querySelectorAll('.audit-form').forEach(form => {
    form.addEventListener('submit', function(e) {
        const btn = this.querySelector('.radar-button');
        if (btn) {
            btn.classList.add('loading');
            btn.disabled = true;
        }
    });
});
</script>
{% endblock %}
